<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Door Knocking Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-card h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-card p {
            color: #666;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h2 {
            color: #667eea;
            font-size: 20px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info {
            color: #666;
            font-size: 14px;
        }

        .btn-small {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-small:hover {
            background: #5568d3;
        }

        .btn-logout {
            background: #dc3545;
        }

        .btn-logout:hover {
            background: #c82333;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .address-input-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .address-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .address-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 4px solid #667eea;
        }

        .address-item:hover {
            background: #e9ecef;
        }

        .address-item.visited {
            border-left-color: #28a745;
        }

        .address-item.salvation {
            border-left-color: #ffc107;
        }

        .address-text {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .address-stats {
            font-size: 12px;
            color: #666;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .visit-list {
            margin-top: 20px;
        }

        .visit-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .visit-date {
            font-weight: 500;
            color: #667eea;
            margin-bottom: 5px;
        }

        .visit-details {
            font-size: 14px;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 40vh;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .legend {
                bottom: 10px;
                right: 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Storage functions
        const storage = {
            get: async (key, shared = false) => {
                try {
                    if (window.storage) {
                        return await window.storage.get(key, shared);
                    }
                    const value = localStorage.getItem(key);
                    return value ? { key, value, shared } : null;
                } catch (error) {
                    const value = localStorage.getItem(key);
                    return value ? { key, value, shared } : null;
                }
            },
            set: async (key, value, shared = false) => {
                try {
                    if (window.storage) {
                        return await window.storage.set(key, value, shared);
                    }
                    localStorage.setItem(key, value);
                    return { key, value, shared };
                } catch (error) {
                    localStorage.setItem(key, value);
                    return { key, value, shared };
                }
            },
            delete: async (key, shared = false) => {
                try {
                    if (window.storage) {
                        return await window.storage.delete(key, shared);
                    }
                    localStorage.removeItem(key);
                    return { key, deleted: true, shared };
                } catch (error) {
                    localStorage.removeItem(key);
                    return { key, deleted: true, shared };
                }
            },
            list: async (prefix = '', shared = false) => {
                try {
                    if (window.storage) {
                        return await window.storage.list(prefix, shared);
                    }
                    const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
                    return { keys, prefix, shared };
                } catch (error) {
                    const keys = Object.keys(localStorage).filter(k => k.startsWith(prefix));
                    return { keys, prefix, shared };
                }
            }
        };

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [addresses, setAddresses] = useState([]);
            const [selectedAddress, setSelectedAddress] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [showAddAddress, setShowAddAddress] = useState(false);
            const [showUserStats, setShowUserStats] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef({});

            // Load data on mount
            useEffect(() => {
                loadUser();
                loadAddresses();
            }, []);

            // Initialize map
            useEffect(() => {
                if (currentUser && !mapInstanceRef.current) {
                    // Center on Whitestown, IN
                    const map = L.map('map').setView([39.9959, -86.3450], 13);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(map);

                    mapInstanceRef.current = map;

                    // Add click handler to add addresses
                    map.on('click', (e) => {
                        if (showAddAddress) {
                            setNewAddress(prev => ({
                                ...prev,
                                latitude: e.latlng.lat,
                                longitude: e.latlng.lng
                            }));
                        }
                    });
                }
            }, [currentUser]);

            // Update markers when addresses change
            useEffect(() => {
                if (mapInstanceRef.current && addresses.length > 0) {
                    updateMarkers();
                }
            }, [addresses]);

            const loadUser = async () => {
                const result = await storage.get('current-user');
                if (result) {
                    setCurrentUser(JSON.parse(result.value));
                }
            };

            const loadAddresses = async () => {
                const result = await storage.get('addresses', true);
                if (result) {
                    setAddresses(JSON.parse(result.value));
                }
            };

            const saveAddresses = async (newAddresses) => {
                await storage.set('addresses', JSON.stringify(newAddresses), true);
                setAddresses(newAddresses);
            };

            const handleQuickKnock = async (address) => {
                // Check if this user already knocked this door today
                const today = new Date().toDateString();
                const alreadyKnockedToday = address.knocks?.some(
                    k => k.volunteer === currentUser.fullName && 
                         new Date(k.date).toDateString() === today
                );

                if (alreadyKnockedToday) {
                    setMessage({ type: 'error', text: 'You already knocked this door today!' });
                    setTimeout(() => setMessage({ type: '', text: '' }), 2000);
                    return;
                }

                const knock = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    volunteer: currentUser.fullName,
                    userId: currentUser.id
                };

                const updatedAddresses = addresses.map(a => {
                    if (a.id === address.id) {
                        return { 
                            ...a, 
                            knocks: [...(a.knocks || []), knock]
                        };
                    }
                    return a;
                });

                await saveAddresses(updatedAddresses);
                setMessage({ type: 'success', text: `Door knocked by ${currentUser.fullName}!` });
                setTimeout(() => setMessage({ type: '', text: '' }), 2000);
            };

            const updateMarkers = () => {
                // Clear existing markers
                Object.values(markersRef.current).forEach(marker => marker.remove());
                markersRef.current = {};

                // Add new markers
                addresses.forEach(address => {
                    const hasSalvations = address.visits?.some(v => v.salvations > 0);
                    const knockCount = address.knocks?.length || 0;
                    const uniqueKnockers = new Set(address.knocks?.map(k => k.userId) || []).size;
                    
                    let color = '#6c757d'; // Not visited (gray)
                    if (hasSalvations) {
                        color = '#ffc107'; // Has salvations (gold)
                    } else if (knockCount > 0) {
                        color = '#28a745'; // Knocked (green)
                    }

                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: ${color}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${uniqueKnockers || ''}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const marker = L.marker([address.latitude, address.longitude], { icon })
                        .addTo(mapInstanceRef.current)
                        .on('click', () => {
                            // Left click - mark as knocked by current user
                            handleQuickKnock(address);
                        })
                        .on('contextmenu', (e) => {
                            // Right click - open details modal
                            e.originalEvent.preventDefault();
                            setSelectedAddress(address);
                            setShowModal(true);
                        });

                    markersRef.current[address.id] = marker;
                });
            };

            const calculateStats = () => {
                const totalAddresses = addresses.length;
                const knockedAddresses = addresses.filter(a => a.knocks && a.knocks.length > 0).length;
                const totalKnocks = addresses.reduce((sum, a) => sum + (a.knocks?.length || 0), 0);
                const totalPresentations = addresses.reduce((sum, a) => 
                    sum + (a.visits?.reduce((vSum, v) => vSum + v.presentations, 0) || 0), 0);
                const totalSalvations = addresses.reduce((sum, a) => 
                    sum + (a.visits?.reduce((vSum, v) => vSum + v.salvations, 0) || 0), 0);

                return { totalAddresses, knockedAddresses, totalKnocks, totalPresentations, totalSalvations };
            };

            if (!currentUser) {
                return <LoginScreen setCurrentUser={setCurrentUser} setMessage={setMessage} />;
            }

            const stats = calculateStats();

            return (
                <div className="app-container">
                    <Header 
                        currentUser={currentUser} 
                        setCurrentUser={setCurrentUser}
                        showAddAddress={showAddAddress}
                        setShowAddAddress={setShowAddAddress}
                    />
                    
                    <div className="main-content">
                        <Sidebar 
                            stats={stats}
                            addresses={addresses}
                            setSelectedAddress={setSelectedAddress}
                            setShowModal={setShowModal}
                            showAddAddress={showAddAddress}
                            setShowAddAddress={setShowAddAddress}
                            saveAddresses={saveAddresses}
                            currentUser={currentUser}
                            setMessage={setMessage}
                            setShowUserStats={setShowUserStats}
                        />
                        
                        <div className="map-container">
                            <div id="map"></div>
                            <MapLegend />
                        </div>
                    </div>

                    {showModal && selectedAddress && (
                        <AddressModal
                            address={selectedAddress}
                            setShowModal={setShowModal}
                            addresses={addresses}
                            saveAddresses={saveAddresses}
                            currentUser={currentUser}
                            setMessage={setMessage}
                        />
                    )}

                    {showUserStats && (
                        <UserStatsModal
                            addresses={addresses}
                            setShowUserStats={setShowUserStats}
                        />
                    )}

                    {message.text && (
                        <div style={{position: 'fixed', top: '80px', left: '50%', transform: 'translateX(-50%)', zIndex: 2000, minWidth: '300px'}}>
                            <div className={message.type === 'error' ? 'error-message' : 'success-message'}>
                                {message.text}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function LoginScreen({ setCurrentUser, setMessage }) {
            const [isRegistering, setIsRegistering] = useState(false);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [fullName, setFullName] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                
                const result = await storage.get('users', true);
                const users = result ? JSON.parse(result.value) : [];
                
                const user = users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    await storage.set('current-user', JSON.stringify(user));
                    setCurrentUser(user);
                    setMessage({ type: 'success', text: 'Login successful!' });
                    setTimeout(() => setMessage({ type: '', text: '' }), 3000);
                } else {
                    setMessage({ type: 'error', text: 'Invalid username or password' });
                    setTimeout(() => setMessage({ type: '', text: '' }), 3000);
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();

                if (password !== confirmPassword) {
                    setMessage({ type: 'error', text: 'Passwords do not match' });
                    setTimeout(() => setMessage({ type: '', text: '' }), 3000);
                    return;
                }

                const result = await storage.get('users', true);
                const users = result ? JSON.parse(result.value) : [];

                if (users.find(u => u.username === username)) {
                    setMessage({ type: 'error', text: 'Username already exists' });
                    setTimeout(() => setMessage({ type: '', text: '' }), 3000);
                    return;
                }

                const newUser = {
                    id: Date.now().toString(),
                    username,
                    password,
                    fullName,
                    createdAt: new Date().toISOString()
                };

                users.push(newUser);
                await storage.set('users', JSON.stringify(users), true);
                await storage.set('current-user', JSON.stringify(newUser));
                setCurrentUser(newUser);
                setMessage({ type: 'success', text: 'Registration successful!' });
                setTimeout(() => setMessage({ type: '', text: '' }), 3000);
            };

            return (
                <div className="login-container">
                    <div className="login-card">
                        <h1>üö™ Door Knocking Tracker</h1>
                        <p>{isRegistering ? 'Create your account' : 'Sign in to continue'}</p>
                        
                        <form onSubmit={isRegistering ? handleRegister : handleLogin}>
                            {isRegistering && (
                                <div className="form-group">
                                    <label>Full Name</label>
                                    <input
                                        type="text"
                                        value={fullName}
                                        onChange={(e) => setFullName(e.target.value)}
                                        required
                                    />
                                </div>
                            )}
                            
                            <div className="form-group">
                                <label>Username</label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    required
                                />
                            </div>
                            
                            <div className="form-group">
                                <label>Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                />
                            </div>
                            
                            {isRegistering && (
                                <div className="form-group">
                                    <label>Confirm Password</label>
                                    <input
                                        type="password"
                                        value={confirmPassword}
                                        onChange={(e) => setConfirmPassword(e.target.value)}
                                        required
                                    />
                                </div>
                            )}
                            
                            <button type="submit" className="btn">
                                {isRegistering ? 'Register' : 'Login'}
                            </button>
                            
                            <button
                                type="button"
                                className="btn btn-secondary"
                                onClick={() => setIsRegistering(!isRegistering)}
                            >
                                {isRegistering ? 'Already have an account? Login' : 'Need an account? Register'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        function Header({ currentUser, setCurrentUser, showAddAddress, setShowAddAddress }) {
            const handleLogout = async () => {
                await storage.delete('current-user');
                setCurrentUser(null);
            };

            return (
                <div className="header">
                    <h2>üö™ Door Knocking Tracker</h2>
                    <div className="header-actions">
                        <span className="user-info">{currentUser.fullName}</span>
                        <button 
                            className="btn-small"
                            onClick={() => setShowAddAddress(!showAddAddress)}
                        >
                            {showAddAddress ? 'Cancel Adding' : '+ Add Address'}
                        </button>
                        <button className="btn-small btn-logout" onClick={handleLogout}>
                            Logout
                        </button>
                    </div>
                </div>
            );
        }

        function Sidebar({ stats, addresses, setSelectedAddress, setShowModal, showAddAddress, setShowAddAddress, saveAddresses, currentUser, setMessage, setShowUserStats }) {
            const [newAddress, setNewAddress] = useState({
                street: '',
                city: '',
                state: '',
                zip: '',
                latitude: 39.9959,
                longitude: -86.3450,
                isApartment: false,
                totalUnits: 1
            });

            const handleAddAddress = async () => {
                if (!newAddress.street || !newAddress.city) {
                    setMessage({ type: 'error', text: 'Please enter street and city' });
                    setTimeout(() => setMessage({ type: '', text: '' }), 3000);
                    return;
                }

                const address = {
                    id: Date.now().toString(),
                    ...newAddress,
                    visits: [],
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };

                const updatedAddresses = [...addresses, address];
                await saveAddresses(updatedAddresses);
                
                setNewAddress({
                    street: '',
                    city: '',
                    state: '',
                    zip: '',
                    latitude: 39.9959,
                    longitude: -86.3450,
                    isApartment: false,
                    totalUnits: 1
                });
                setShowAddAddress(false);
                setMessage({ type: 'success', text: 'Address added successfully!' });
                setTimeout(() => setMessage({ type: '', text: '' }), 3000);
            };

            return (
                <div className="sidebar">
                    <div className="section">
                        <h3>üìä Statistics</h3>
                        <div className="stats-grid">
                            <div className="stat-card">
                                <div className="stat-number">{stats.totalAddresses}</div>
                                <div className="stat-label">Total Addresses</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{stats.knockedAddresses}</div>
                                <div className="stat-label">Doors Knocked</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{stats.totalPresentations}</div>
                                <div className="stat-label">Presentations</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-number">{stats.totalSalvations}</div>
                                <div className="stat-label">Salvations</div>
                            </div>
                        </div>
                    </div>

                    {showAddAddress && (
                        <div className="section">
                            <h3>‚ûï Add New Address</h3>
                            <div className="address-input-section">
                                <div className="input-group">
                                    <label>Street Address</label>
                                    <input
                                        type="text"
                                        value={newAddress.street}
                                        onChange={(e) => setNewAddress({...newAddress, street: e.target.value})}
                                        placeholder="123 Main St"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>City</label>
                                    <input
                                        type="text"
                                        value={newAddress.city}
                                        onChange={(e) => setNewAddress({...newAddress, city: e.target.value})}
                                        placeholder="Whitestown"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>State</label>
                                    <input
                                        type="text"
                                        value={newAddress.state}
                                        onChange={(e) => setNewAddress({...newAddress, state: e.target.value})}
                                        placeholder="IN"
                                        maxLength="2"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>ZIP Code</label>
                                    <input
                                        type="text"
                                        value={newAddress.zip}
                                        onChange={(e) => setNewAddress({...newAddress, zip: e.target.value})}
                                        placeholder="46075"
                                    />
                                </div>
                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="isApartment"
                                        checked={newAddress.isApartment}
                                        onChange={(e) => setNewAddress({...newAddress, isApartment: e.target.checked})}
                                    />
                                    <label htmlFor="isApartment">Apartment Complex</label>
                                </div>
                                {newAddress.isApartment && (
                                    <div className="input-group">
                                        <label>Total Units</label>
                                        <input
                                            type="number"
                                            value={newAddress.totalUnits}
                                            onChange={(e) => setNewAddress({...newAddress, totalUnits: parseInt(e.target.value) || 1})}
                                            min="1"
                                        />
                                    </div>
                                )}
                                <button className="btn" onClick={handleAddAddress}>
                                    Add Address
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="section">
                        <h3>üìç Addresses ({addresses.length})</h3>
                        <div className="address-list">
                            {addresses.map(address => {
                                const hasSalvations = address.visits?.some(v => v.salvations > 0);
                                const knockCount = address.knocks?.length || 0;
                                const className = `address-item ${knockCount > 0 ? 'visited' : ''} ${hasSalvations ? 'salvation' : ''}`;
                                
                                return (
                                    <div
                                        key={address.id}
                                        className={className}
                                        onClick={() => {
                                            setSelectedAddress(address);
                                            setShowModal(true);
                                        }}
                                    >
                                        <div className="address-text">
                                            {address.street}, {address.city}
                                        </div>
                                        <div className="address-stats">
                                            {address.isApartment && `${address.totalUnits} units ‚Ä¢ `}
                                            {knockCount} knock{knockCount !== 1 ? 's' : ''}
                                            {hasSalvations && ' ‚Ä¢ ‚≠ê Salvations'}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    
                    <div className="section">
                        <button 
                            className="btn" 
                            onClick={() => setShowUserStats(true)}
                            style={{width: '100%'}}
                        >
                            üë• View User Statistics
                        </button>
                    </div>
                </div>
            );
        }

        function AddressModal({ address, setShowModal, addresses, saveAddresses, currentUser, setMessage }) {
            const [presentations, setPresentations] = useState(0);
            const [salvations, setSalvations] = useState(0);
            const [notes, setNotes] = useState('');
            const [contactMade, setContactMade] = useState(false);

            const handleAddVisit = async () => {
                const visit = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    volunteer: currentUser.fullName,
                    presentations: parseInt(presentations) || 0,
                    salvations: parseInt(salvations) || 0,
                    contactMade,
                    notes
                };

                const updatedAddresses = addresses.map(a => {
                    if (a.id === address.id) {
                        return { ...a, visits: [...a.visits, visit] };
                    }
                    return a;
                });

                await saveAddresses(updatedAddresses);
                setMessage({ type: 'success', text: 'Visit logged successfully!' });
                setTimeout(() => setMessage({ type: '', text: '' }), 3000);
                setPresentations(0);
                setSalvations(0);
                setNotes('');
                setContactMade(false);
            };

            return (
                <div className="modal" onClick={() => setShowModal(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>{address.street}, {address.city}</h3>
                            <button className="close-btn" onClick={() => setShowModal(false)}>√ó</button>
                        </div>

                        {address.isApartment && (
                            <div style={{marginBottom: '15px', padding: '10px', background: '#f8f9fa', borderRadius: '6px'}}>
                                <strong>Apartment Complex</strong> - {address.totalUnits} units
                            </div>
                        )}

                        <div className="section">
                            <h3>Log New Visit</h3>
                            <div className="input-group">
                                <label>Presentations Given</label>
                                <input
                                    type="number"
                                    value={presentations}
                                    onChange={(e) => setPresentations(e.target.value)}
                                    min="0"
                                />
                            </div>
                            <div className="input-group">
                                <label>Salvations</label>
                                <input
                                    type="number"
                                    value={salvations}
                                    onChange={(e) => setSalvations(e.target.value)}
                                    min="0"
                                />
                            </div>
                            <div className="checkbox-group">
                                <input
                                    type="checkbox"
                                    id="contactMade"
                                    checked={contactMade}
                                    onChange={(e) => setContactMade(e.target.checked)}
                                />
                                <label htmlFor="contactMade">Contact Made</label>
                            </div>
                            <div className="input-group">
                                <label>Notes</label>
                                <input
                                    type="text"
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    placeholder="Any additional notes..."
                                />
                            </div>
                            <button className="btn" onClick={handleAddVisit}>
                                Log Visit
                            </button>
                        </div>

                        {address.visits?.length > 0 && (
                            <div className="visit-list">
                                <h3>Visit History ({address.visits.length})</h3>
                                {address.visits.slice().reverse().map(visit => (
                                    <div key={visit.id} className="visit-item">
                                        <div className="visit-date">
                                            {new Date(visit.date).toLocaleDateString()} - {visit.volunteer}
                                        </div>
                                        <div className="visit-details">
                                            Presentations: {visit.presentations} | Salvations: {visit.salvations}
                                            {visit.contactMade && ' | Contact Made'}
                                            {visit.notes && <div style={{marginTop: '5px', fontStyle: 'italic'}}>"{visit.notes}"</div>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {address.knocks?.length > 0 && (
                            <div className="visit-list">
                                <h3>Knock History ({address.knocks.length})</h3>
                                {address.knocks.slice().reverse().map(knock => (
                                    <div key={knock.id} className="visit-item" style={{background: '#e7f3ff'}}>
                                        <div className="visit-date">
                                            {new Date(knock.date).toLocaleDateString()} at {new Date(knock.date).toLocaleTimeString()} - {knock.volunteer}
                                        </div>
                                        <div className="visit-details">
                                            Door knocked
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function UserStatsModal({ addresses, setShowUserStats }) {
            // Calculate stats for each user
            const calculateUserStats = () => {
                const userStatsMap = {};
                
                // Process knocks
                addresses.forEach(address => {
                    if (address.knocks) {
                        address.knocks.forEach(knock => {
                            if (!userStatsMap[knock.volunteer]) {
                                userStatsMap[knock.volunteer] = {
                                    name: knock.volunteer,
                                    knockCount: 0,
                                    presentations: 0,
                                    salvations: 0,
                                    contactsMade: 0
                                };
                            }
                            userStatsMap[knock.volunteer].knockCount++;
                        });
                    }
                    
                    // Process visits for presentations and salvations
                    if (address.visits) {
                        address.visits.forEach(visit => {
                            if (!userStatsMap[visit.volunteer]) {
                                userStatsMap[visit.volunteer] = {
                                    name: visit.volunteer,
                                    knockCount: 0,
                                    presentations: 0,
                                    salvations: 0,
                                    contactsMade: 0
                                };
                            }
                            userStatsMap[visit.volunteer].presentations += visit.presentations || 0;
                            userStatsMap[visit.volunteer].salvations += visit.salvations || 0;
                            if (visit.contactMade) {
                                userStatsMap[visit.volunteer].contactsMade++;
                            }
                        });
                    }
                });
                
                // Convert to array and sort by knock count
                return Object.values(userStatsMap).sort((a, b) => b.knockCount - a.knockCount);
            };
            
            const userStats = calculateUserStats();
            
            return (
                <div className="modal" onClick={() => setShowUserStats(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '700px'}}>
                        <div className="modal-header">
                            <h3>üë• User Statistics</h3>
                            <button className="close-btn" onClick={() => setShowUserStats(false)}>√ó</button>
                        </div>
                        
                        {userStats.length === 0 ? (
                            <p style={{textAlign: 'center', color: '#666', padding: '20px'}}>
                                No user activity yet. Start knocking doors!
                            </p>
                        ) : (
                            <div>
                                {userStats.map((user, index) => (
                                    <div key={user.name} style={{
                                        background: '#f8f9fa',
                                        padding: '20px',
                                        borderRadius: '8px',
                                        marginBottom: '15px',
                                        borderLeft: `4px solid ${index === 0 ? '#ffc107' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#667eea'}`
                                    }}>
                                        <div style={{
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            marginBottom: '12px'
                                        }}>
                                            <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                                                {index < 3 && (
                                                    <span style={{fontSize: '24px'}}>
                                                        {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â'}
                                                    </span>
                                                )}
                                                <h4 style={{margin: 0, color: '#333'}}>{user.name}</h4>
                                            </div>
                                        </div>
                                        
                                        <div style={{
                                            display: 'grid',
                                            gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                            gap: '15px'
                                        }}>
                                            <div style={{textAlign: 'center', background: 'white', padding: '12px', borderRadius: '6px'}}>
                                                <div style={{fontSize: '24px', fontWeight: 'bold', color: '#667eea'}}>
                                                    {user.knockCount}
                                                </div>
                                                <div style={{fontSize: '12px', color: '#666'}}>Doors Knocked</div>
                                            </div>
                                            
                                            <div style={{textAlign: 'center', background: 'white', padding: '12px', borderRadius: '6px'}}>
                                                <div style={{fontSize: '24px', fontWeight: 'bold', color: '#28a745'}}>
                                                    {user.contactsMade}
                                                </div>
                                                <div style={{fontSize: '12px', color: '#666'}}>Contacts Made</div>
                                            </div>
                                            
                                            <div style={{textAlign: 'center', background: 'white', padding: '12px', borderRadius: '6px'}}>
                                                <div style={{fontSize: '24px', fontWeight: 'bold', color: '#17a2b8'}}>
                                                    {user.presentations}
                                                </div>
                                                <div style={{fontSize: '12px', color: '#666'}}>Presentations</div>
                                            </div>
                                            
                                            <div style={{textAlign: 'center', background: 'white', padding: '12px', borderRadius: '6px'}}>
                                                <div style={{fontSize: '24px', fontWeight: 'bold', color: '#ffc107'}}>
                                                    {user.salvations}
                                                </div>
                                                <div style={{fontSize: '12px', color: '#666'}}>Salvations</div>
                                            </div>
                                        </div>
                                        
                                        {user.salvations > 0 && (
                                            <div style={{
                                                marginTop: '12px',
                                                padding: '10px',
                                                background: 'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)',
                                                borderRadius: '6px',
                                                color: 'white',
                                                textAlign: 'center',
                                                fontWeight: 'bold',
                                                fontSize: '14px'
                                            }}>
                                                ‚≠ê {user.salvations} Soul{user.salvations !== 1 ? 's' : ''} Saved!
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        <div style={{marginTop: '20px', padding: '15px', background: '#e7f3ff', borderRadius: '8px', fontSize: '14px', color: '#666'}}>
                            <strong>Note:</strong> Rankings are based on doors knocked. Keep up the great work spreading the word!
                        </div>
                    </div>
                </div>
            );
        }

        function MapLegend() {
            return (
                <div className="legend">
                    <div className="legend-title">Legend</div>
                    <div className="legend-item">
                        <div className="legend-color" style={{backgroundColor: '#6c757d'}}></div>
                        <span>Not Visited</span>
                    </div>
                    <div className="legend-item">
                        <div className="legend-color" style={{backgroundColor: '#28a745'}}></div>
                        <span>Visited</span>
                    </div>
                    <div className="legend-item">
                        <div className="legend-color" style={{backgroundColor: '#ffc107'}}></div>
                        <span>Salvations</span>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
